name: CI checks

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA for checks (default: latest in branch)'
        required: false
        default: ''
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  semgrep-ci:
    runs-on: self-hosted
    permissions:
      contents: read

    steps:
    - name: Determine scan ref
      env:
        INPUT_SHA: ${{ github.event.inputs.sha }}
        GITHUB_SHA_REF: ${{ github.sha }}
      run: |
        if [ -n "$INPUT_SHA" ]; then
          echo "SCAN_REF=$INPUT_SHA" >> "$GITHUB_ENV"
        else
          echo "SCAN_REF=$GITHUB_SHA_REF" >> "$GITHUB_ENV"
        fi

    - name: Checkout repository at selected commit
      uses: actions/checkout@v4
      with:
        ref: ${{ env.SCAN_REF }}

    - name: Install Semgrep
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip pipx
        pipx ensurepath
        pipx install semgrep || pipx upgrade semgrep
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"

    - name: Run Semgrep (p/ci)
      continue-on-error: true
      run: semgrep --config p/ci .
